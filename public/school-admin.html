<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BECE Prep - Teacher Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">BE</div>
        <div>
          <h1>Teacher Admin Panel</h1>
          <p class="lead">Manage your school and students on BECE Prep</p>
        </div>
      </div>
      <div>
        <span style="color: var(--muted); margin-right: 16px;" id="schoolInfo"></span>
        <button id="logoutBtn" class="btn ghost">Logout</button>
      </div>
    </header>

    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
      <!-- School Information -->
      <div class="card">
        <h3>🏫 School Details</h3>
        <div id="schoolDetails">
          <div><strong>School Code:</strong> <span id="schoolCodeDisplay"></span></div>
          <div><strong>Students Registered:</strong> <span id="studentCount">0</span></div>
          <div><strong>Registration Date:</strong> <span id="regDate"></span></div>
        </div>
        
        <div style="margin-top: 20px;">
          <h4>Share School Code</h4>
          <div style="background: var(--glass); padding: 16px; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: bold; text-align: center; color: var(--accent);" id="shareableCode"></div>
            <div style="text-align: center; color: var(--muted); font-size: 14px; margin-top: 8px;">
              Share this code with your students
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <h3>⚡ Quick Actions</h3>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button class="btn" id="bulkImportBtn">📥 Bulk Import Students</button>
          <button class="btn ghost" id="generateReportsBtn">📊 Generate Reports</button>
          <button class="btn ghost" id="manageClassesBtn">👨‍🏫 Manage Classes</button>
          <button class="btn ghost" id="viewAnalyticsBtn">📈 View Analytics</button>
        </div>
      </div>

      <!-- Student Management -->
      <div class="card" style="grid-column: span 2;">
        <h3>👨‍🎓 Student Management</h3>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <input type="text" id="searchStudents" placeholder="Search students..." style="flex: 1;">
          <button class="btn" id="addStudentBtn">+ Add Student</button>
        </div>
        
        <div id="studentsList" class="students-table">
          <!-- Dynamic student list -->
        </div>
      </div>

      <!-- Bulk Import Modal -->
      <div id="bulkImportModal" class="modal" style="display: none;">
        <div class="modal-content">
          <h3>📥 Bulk Import Students</h3>
          <p>Upload a CSV file or enter student details manually</p>
          
          <div style="margin: 20px 0;">
            <textarea id="studentData" placeholder="Full Name,Class&#10;Kwame Mensah,JHS 3A&#10;Ama Serwaa,JHS 3B&#10;Kofi Annan,JHS 3A" 
                      style="width: 100%; height: 200px; padding: 12px; border: 1px solid var(--border); border-radius: 8px;"></textarea>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button class="btn ghost" id="cancelImport">Cancel</button>
            <button class="btn" id="confirmImport">Import Students</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { SchoolManager, generateStudentUsername } from '../js/schools.js';
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { app } from '../js/auth.js';

    const auth = getAuth(app);
    const schoolManager = new SchoolManager();

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      await initializeTeacherAdmin(user);
    });

    async function initializeTeacherAdmin(user) {
      // Load school data for this teacher
      const schoolData = await schoolManager.getTeacherSchool(user.uid);
      
      if (schoolData) {
        displaySchoolInfo(schoolData);
        loadStudentsList(schoolData.students);
      } else {
        // Redirect to school registration
        window.location.href = 'school-registration.html';
      }

      setupEventListeners();
    }

    function displaySchoolInfo(school) {
      document.getElementById('schoolInfo').textContent = school.name;
      document.getElementById('schoolCodeDisplay').textContent = school.code;
      document.getElementById('shareableCode').textContent = school.code;
      document.getElementById('studentCount').textContent = school.students.length;
      document.getElementById('regDate').textContent = new Date(school.registeredAt).toLocaleDateString();
    }

    function loadStudentsList(students) {
      const container = document.getElementById('studentsList');
      
      if (students.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--muted);">
            <p>No students registered yet.</p>
            <p>Share your school code: <strong>${document.getElementById('shareableCode').textContent}</strong></p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid var(--border);">
              <th style="text-align: left; padding: 12px;">Student Name</th>
              <th style="text-align: left; padding: 12px;">Class</th>
              <th style="text-align: left; padding: 12px;">Username</th>
              <th style="text-align: left; padding: 12px;">Join Date</th>
              <th style="text-align: left; padding: 12px;">Status</th>
            </tr>
          </thead>
          <tbody>
            ${students.map(student => `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 12px;">${student.fullName}</td>
                <td style="padding: 12px;">${student.class}</td>
                <td style="padding: 12px;">${student.username || 'Not set'}</td>
                <td style="padding: 12px;">${new Date(student.joinedAt).toLocaleDateString()}</td>
                <td style="padding: 12px;">
                  <span style="color: var(--success);">●</span> Active
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function setupEventListeners() {
      // Bulk import functionality
      document.getElementById('bulkImportBtn').addEventListener('click', () => {
        document.getElementById('bulkImportModal').style.display = 'block';
      });

      document.getElementById('cancelImport').addEventListener('click', () => {
        document.getElementById('bulkImportModal').style.display = 'none';
      });

      document.getElementById('confirmImport').addEventListener('click', async () => {
        const studentData = document.getElementById('studentData').value;
        const students = parseStudentData(studentData);
        
        const results = await schoolManager.bulkImportStudents(
          document.getElementById('schoolCodeDisplay').textContent,
          students
        );

        alert(`Imported ${results.filter(r => r.success).length} students successfully`);
        document.getElementById('bulkImportModal').style.display = 'none';
        location.reload();
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => {
          window.location.href = '../index.html';
        });
      });
    }

    function parseStudentData(data) {
      return data.split('\n')
        .filter(line => line.trim())
        .map(line => {
          const [fullName, studentClass] = line.split(',').map(part => part.trim());
          return { fullName, studentClass: studentClass || 'JHS 3' };
        });
    }
  </script>

  <style>
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
    }

    .students-table {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</body>
</html>