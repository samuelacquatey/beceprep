<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BECE Past Questions â€” Select Filters</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css?v=2.1">
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">BE</div>
        <div>
          <h1>BECE Prep [Interactive MVP]</h1>
          <p class="lead">Practice by subject or year â€¢ Get performance analytics and improvement tips</p>
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <button id="dashboardBtn" class="btn ghost">ğŸ“Š Analytics</button>
        <button id="socialBtn" class="btn ghost">ğŸ‘¥ Social Hub</button>
        <button id="flashcardsBtn" class="btn ghost">ğŸ´ Flashcards</button>
        <button id="logoutBtn" class="btn ghost">Logout</button>
      </div>
    </header>

    <div class="card fade-in">
      <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
      </div>

      <div class="section">
        <h3>ğŸ¯ Configure Your Session</h3>
        <p class="text-sm text-muted mb-4">Select the subjects and mode you want to practice.</p>

        <div class="filter-group" style="display:flex;gap:12px;align-items:center;margin-bottom:16px; flex-wrap:wrap;">
          <select id="yearSelect" aria-label="Select year" class="flex-1">
            <option value="all">All Years</option>
          </select>

          <select id="modeSelect" aria-label="Mode" class="flex-1">
            <option value="practice">ğŸ“ Practice Mode</option>
            <option value="exam">â±ï¸ Exam Mode</option>
          </select>
        </div>

        <h3 class="mt-4">Subjects</h3>
        <div class="subjects" id="subjectsList">
          <!-- Populated by JS -->
          <div style="padding: 20px; text-align: center; width: 100%; color: var(--muted);">Loading subjects...</div>
        </div>
      </div>

      <div class="section mt-4" style="border-top: 1px solid var(--border); padding-top: 20px;">
        <div class="controls" style="justify-content: space-between;">
          <label class="switch" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="checkbox" id="endlessMode">
            <span style="font-size: 14px; color: var(--text-main)">â™¾ï¸ Endless Mode</span>
          </label>
          <button id="startBtn" class="btn primary">Start Quiz ğŸš€</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth } from './js/auth.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { QUIZ_METADATA } from './js/metadata.js';

    // DOM Elements
    const subjectsList = document.getElementById('subjectsList');
    const yearSelect = document.getElementById('yearSelect');
    const startBtn = document.getElementById('startBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardBtn = document.getElementById('dashboardBtn');
    const socialBtn = document.getElementById('socialBtn');
    const flashcardsBtn = document.getElementById('flashcardsBtn');

    // State
    let activeVariant = 'A';
    let selectedSubjects = new Set();

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) loadingOverlay.style.display = 'none';

      // Check auth
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = 'index.html';
        }
      });

      // A/B Test Assignment
      assignABVariant();

      // Instant Load using Metadata
      populateFilters();
    });

    function assignABVariant() {
      const storedVariant = localStorage.getItem('quiz_ui_variant');
      if (storedVariant) {
        activeVariant = storedVariant;
      } else {
        activeVariant = Math.random() < 0.5 ? 'chips' : 'carousel';
        localStorage.setItem('quiz_ui_variant', activeVariant);
      }
    }

    // --- Core Logic: Active Filtration ---
    function populateFilters() {

      renderChips(QUIZ_METADATA.subjects);

      // 2. Initial Year Population (All Years)
      updateYearDropdown();
    }

    function updateYearDropdown() {
      const selectedNames = Array.from(selectedSubjects);
      const availableYears = QUIZ_METADATA.getAvailableYears(selectedNames);

      const currentSelection = yearSelect.value;

      // Rebuild Options
      let html = '<option value="all">All Years</option>';
      availableYears.forEach(year => {
        html += `<option value="${year}">${year}</option>`;
      });

      yearSelect.innerHTML = html;

      // Attempt to preserve selection if valid
      if (currentSelection !== 'all' && availableYears.includes(Number(currentSelection))) {
        yearSelect.value = currentSelection;
      } else {
        yearSelect.value = 'all';
      }
    }

    // --- Renderers ---

    function renderChips(subjects) {
      subjectsList.innerHTML = '<div class="subject-chip-grid" role="group" aria-label="Subject Selection"></div>';
      const container = subjectsList.querySelector('.subject-chip-grid');

      subjects.forEach(subject => {
        const chip = document.createElement('div');
        chip.className = 'subject-chip';
        // Restore original structure
        chip.innerHTML = `<span>${subject.icon}</span> <span>${subject.name}</span>`;
        chip.dataset.subject = subject.name;

        chip.onclick = () => toggleSubject(chip, subject.name);
        container.appendChild(chip);
      });
    }



    function toggleSubject(el, subjectName) {
      if (selectedSubjects.has(subjectName)) {
        selectedSubjects.delete(subjectName);
        el.classList.remove('selected');
        // Check for both possible active classes just in case css uses one or other
        el.classList.remove('active');
      } else {
        selectedSubjects.add(subjectName);
        el.classList.add('selected');
        el.classList.add('active');
      }

      // TRIGGER ACTIVE FILTRATION
      updateYearDropdown();
    }

    // Start Quiz
    startBtn.onclick = () => {
      // Map selected display names -> canonical dbKeys
      const subjectKeys = Array.from(selectedSubjects).map(name => {
        const meta = QUIZ_METADATA.subjects.find(s => s.name === name && s.years.includes(yearSelect.value));
        // Fallback: if not found for some reason, keep the name
        return meta ? meta.dbKey : name;
      });

      const settings = {
        subjects: subjectKeys,    // store KEYS, not names
        year: yearSelect.value,
        mode: document.getElementById('modeSelect').value,
        endless: document.getElementById('endlessMode').checked
      };

      if (settings.subjects.length === 0) {
        alert('Please select at least one subject!');
        return;
      }

      sessionStorage.setItem('quizSettings', JSON.stringify(settings));
      window.location.href = 'qna.html';
    };


    // Navigation
    logoutBtn.addEventListener('click', () => signOut(auth));
    dashboardBtn.addEventListener('click', () => window.location.href = 'dashboard.html');
    flashcardsBtn.addEventListener('click', () => window.location.href = 'flashcards.html');
    socialBtn.addEventListener('click', () => window.location.href = 'social.html');

  </script>
</body>

</html>