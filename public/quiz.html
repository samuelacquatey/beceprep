<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BECE Past Questions â€” Select Filters</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">BE</div>
        <div>
          <h1>BECE Prep [Interactive MVP]</h1>
          <p class="lead">Practice by subject or year â€¢ Get performance analytics and improvement tips</p>
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <button id="dashboardBtn" class="btn ghost">ðŸ“Š Analytics</button>
        <button id="socialBtn" class="btn ghost">ðŸ‘¥ Social Hub</button>
        <button id="flashcardsBtn" class="btn ghost">ðŸŽ´ Flashcards</button>
        <button id="logoutBtn" class="btn ghost">Logout</button>
      </div>
    </header>

    <div class="card">
      <div class="section">
        <h3>Filter</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <select id="yearSelect" aria-label="Select year">
            <option value="all">All years</option>
          </select>
          <label style="color:var(--muted);font-size:13px"> </label>
          <select id="modeSelect" aria-label="Mode">
            <option value="practice">Practice Mode</option>
            <option value="exam">Exam Mode</option>
          </select>
        </div>

        <h3>Subjects</h3>
        <div class="subjects" id="subjectsList"></div>
      </div>

      <div class="section">
        <h3>Controls</h3>
        <div class="controls">
          <button id="startBtn" class="btn">Start Quiz</button>
          <label class="switch">
            <input type="checkbox" id="endlessMode">
            <span style="font-size: 13px; color: var(--muted)">Endless Mode</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth } from './js/auth.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { fetchQuestions } from './js/database.js';

    // DOM Elements
    const subjectsList = document.getElementById('subjectsList');
    const yearSelect = document.getElementById('yearSelect');
    const startBtn = document.getElementById('startBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardBtn = document.getElementById('dashboardBtn');
    const socialBtn = document.getElementById('socialBtn');
    const flashcardsBtn = document.getElementById('flashcardsBtn');

    // State
    let allQuestions = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check auth
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = 'index.html';
        }
      });

      // Load Data
      try {
        allQuestions = await fetchQuestions();
        console.log('Loaded questions:', allQuestions.length);

        populateFilters();
      } catch (error) {
        console.error('Error loading questions:', error);
        alert('Failed to load questions. Please refresh.');
      }
    });

    function populateFilters() {
      // Extract unique subjects and years
      const subjects = [...new Set(allQuestions.map(q => q.subject))].sort();
      const years = [...new Set(allQuestions.map(q => q.year))].sort((a, b) => b - a);

      // Populate Subjects
      subjectsList.innerHTML = subjects.map(subject => `
        <label class="subject-chip">
          <input type="checkbox" value="${subject}" checked>
          <span>${subject}</span>
        </label>
      `).join('');

      // Populate Years
      yearSelect.innerHTML = '<option value="all">All years</option>' +
        years.map(year => `<option value="${year}">${year}</option>`).join('');
    }

    // Start Quiz
    startBtn.addEventListener('click', () => {
      const selectedSubjects = Array.from(document.querySelectorAll('#subjectsList input:checked'))
        .map(cb => cb.value);

      const selectedYear = yearSelect.value;
      const mode = document.getElementById('modeSelect').value;
      const endless = document.getElementById('endlessMode').checked;

      if (selectedSubjects.length === 0) {
        alert('Please select at least one subject');
        return;
      }

      // Save settings
      sessionStorage.removeItem('current_quiz_answers'); // Clear old session
      sessionStorage.setItem('quizSettings', JSON.stringify({
        subjects: selectedSubjects,
        year: selectedYear,
        mode: mode,
        endless: endless
      }));

      window.location.href = 'qna.html';
    });

    // Navigation
    logoutBtn.addEventListener('click', () => signOut(auth));
    dashboardBtn.addEventListener('click', () => window.location.href = 'dashboard.html');
    // socialBtn and flashcardsBtn placeholders
  </script>
</body>

</html>