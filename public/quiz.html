<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BECE Past Questions â€” Select Filters</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">BE</div>
        <div>
          <h1>BECE Prep [Interactive MVP]</h1>
          <p class="lead">Practice by subject or year â€¢ Get performance analytics and improvement tips</p>
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <button id="dashboardBtn" class="btn ghost">ðŸ“Š Analytics</button>
        <button id="socialBtn" class="btn ghost">ðŸ‘¥ Social Hub</button>
        <button id="flashcardsBtn" class="btn ghost">ðŸŽ´ Flashcards</button>
        <button id="logoutBtn" class="btn ghost">Logout</button>
      </div>
    </header>

    <div class="card">
      <div class="section">
        <h3>Filter</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <select id="yearSelect" aria-label="Select year">
            <option value="all">All years</option>
          </select>
          <label style="color:var(--muted);font-size:13px"> </label>
          <select id="modeSelect" aria-label="Mode">
            <option value="practice">Practice Mode</option>
            <option value="exam">Exam Mode</option>
          </select>
        </div>

        <h3>Subjects</h3>
        <div class="subjects" id="subjectsList"></div>
      </div>

      <div class="section">
        <h3>Controls</h3>
        <div class="controls">
          <button id="startBtn" class="btn">Start Quiz</button>
          <label class="switch">
            <input type="checkbox" id="endlessMode">
            <span style="font-size: 13px; color: var(--muted)">Endless Mode</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth } from './js/auth.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { fetchQuestions } from './js/database.js';

    // DOM Elements
    const subjectsList = document.getElementById('subjectsList');
    const yearSelect = document.getElementById('yearSelect');
    const startBtn = document.getElementById('startBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardBtn = document.getElementById('dashboardBtn');
    const socialBtn = document.getElementById('socialBtn');
    const flashcardsBtn = document.getElementById('flashcardsBtn');

    // State
    let allQuestions = [];
    let activeVariant = 'A'; // Default to A
    let selectedSubjects = new Set(); // Using Set for easier toggling

    // Subject Icons Mapping
    const subjectIcons = {
      'Mathematics': 'ðŸ“',
      'English Language': 'ðŸ“–',
      'Integrated Science': 'ðŸ”¬',
      'Social Studies': 'ðŸŒ',
      'ICT': 'ðŸ’»',
      'RME': 'ðŸ™',
      'French': 'ðŸ‡«ðŸ‡·',
      'BDT': 'ðŸ”¨'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check auth
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = 'index.html';
        }
      });

      // A/B Test Assignment
      assignABVariant();

      // Load Data
      try {
        allQuestions = await fetchQuestions();
        console.log('Loaded questions:', allQuestions.length);

        populateFilters();
      } catch (error) {
        console.error('Error loading questions:', error);
        alert('Failed to load questions. Please refresh.');
      }
    });

    function assignABVariant() {
      // Check if user has already been assigned
      const storedVariant = localStorage.getItem('quiz_ui_variant');

      if (storedVariant) {
        activeVariant = storedVariant;
        console.log(`User retrieved active variant: ${activeVariant}`);
      } else {
        // Randomly assign A (Chips) or B (Carousel)
        activeVariant = Math.random() < 0.5 ? 'chips' : 'carousel';
        localStorage.setItem('quiz_ui_variant', activeVariant);
        console.log(`User assigned new variant: ${activeVariant}`);
      }
    }

    function populateFilters() {
      // Extract unique subjects and years
      const subjects = [...new Set(allQuestions.map(q => q.subject))].sort();
      const years = [...new Set(allQuestions.map(q => q.year))].sort((a, b) => b - a);

      // Default: NO subjects selected (User must select)
      selectedSubjects.clear();

      // Render Subjects based on Variant
      if (activeVariant === 'carousel') {
        renderCarousel(subjects);
      } else {
        renderChips(subjects);
      }

      // Populate Years (Common)
      yearSelect.innerHTML = '<option value="all">All years</option>' +
        years.map(year => `<option value="${year}">${year}</option>`).join('');
    }

    function renderChips(subjects) {
      subjectsList.innerHTML = `
        <div class="subject-chip-grid">
          ${subjects.map(subject => `
            <div class="subject-chip" data-subject="${subject}" onclick="toggleSubject('${subject}', this)">
              <span>${subjectIcons[subject] || 'ðŸ“š'}</span>
              <span>${subject}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderCarousel(subjects) {
      subjectsList.innerHTML = `
        <div class="subject-carousel-container">
          <div class="subject-carousel">
             ${subjects.map(subject => `
              <div class="carousel-card" data-subject="${subject}" onclick="toggleSubject('${subject}', this)">
                <div class="carousel-icon">${subjectIcons[subject] || 'ðŸ“š'}</div>
                <div class="carousel-title">${subject}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Expose to window for onclick
    window.toggleSubject = function (subject, element) {
      if (selectedSubjects.has(subject)) {
        selectedSubjects.delete(subject);
        element.classList.remove('selected');
      } else {
        selectedSubjects.add(subject);
        element.classList.add('selected');
      }
    };

    // Start Quiz
    startBtn.addEventListener('click', () => {
      const subjectsArray = Array.from(selectedSubjects);
      const selectedYear = yearSelect.value;
      const mode = document.getElementById('modeSelect').value;
      const endless = document.getElementById('endlessMode').checked;

      if (subjectsArray.length === 0) {
        alert('Please select at least one subject');
        return;
      }

      // Save settings
      sessionStorage.removeItem('current_quiz_answers'); // Clear old session
      sessionStorage.setItem('quizSettings', JSON.stringify({
        subjects: subjectsArray,
        year: selectedYear,
        mode: mode,
        endless: endless,
        uiVariant: activeVariant // Track which UI they used
      }));

      window.location.href = 'qna.html';
    });

    // Navigation
    logoutBtn.addEventListener('click', () => signOut(auth));
    dashboardBtn.addEventListener('click', () => window.location.href = 'dashboard.html');
    flashcardsBtn.addEventListener('click', () => window.location.href = 'flashcards.html');
    socialBtn.addEventListener('click', () => window.location.href = 'social.html');

  </script>
</body>

</html>