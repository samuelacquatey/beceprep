<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BECE Past Questions â€” Select Filters</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
  <header>
    <div class="brand">
      <div class="logo">BE</div>
      <div>
        <h1>BECE Prep [Interactive MVP]</h1>
        <p class="lead">Practice by subject or year â€¢ Get performance analytics and improvement tips</p>
      </div>
    </div>
    <div style="display: flex; gap: 8px; align-items: center;">
      <button id="dashboardBtn" class="btn ghost">ðŸ“Š Analytics</button>
      <button id="socialBtn" class="btn ghost">ðŸ‘¥ Social</button>
      <button id="flashcardsBtn" class="btn ghost">ðŸŽ´ Flashcards</button>
      <button id="logoutBtn" class="btn ghost">Logout</button>
    </div>
  </header>

    <div class="card">
      <div class="section">
        <h3>Filter</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <select id="yearSelect" aria-label="Select year">
            <option value="all">All years</option>
          </select>
          <label style="color:var(--muted);font-size:13px">    </label>
          <select id="modeSelect" aria-label="Mode">
            <option value="practice">Practice Mode</option>
            <option value="exam">Exam Mode</option>
          </select>
        </div>

        <h3>Subjects</h3>
        <div class="subjects" id="subjectsList"></div>
      </div>

      <div class="section">
        <h3>Controls</h3>
        <div class="controls">
          <button id="startBtn" class="btn">Start Quiz</button>
          <label class="switch">
            <input type="checkbox" id="endlessMode">
            <span style="font-size: 13px; color: var(--muted)">Endless Mode</span>
          </label>
        </div>
      </div>
    </div>

    <footer class="small">This is a front-end MVP with dummy questions. Answers are stored in your browser's localStorage.</footer>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { app } from "./js/auth.js";
    import { ENHANCED_QUESTIONS } from "./js/data/questionBank.js";

    const auth = getAuth(app);

    // Add to both quiz.html and qna.html
    document.getElementById('dashboardBtn').addEventListener('click', () => {
      window.location.href = 'dashboard.html';
    });

    document.getElementById('socialBtn').addEventListener('click', () => {
      window.location.href = 'social.html';
    });

    document.getElementById('flashcardsBtn').addEventListener('click', () => {
      window.location.href = 'flashcards.html';
    });

    /*********************** Enhanced Question Dataset ************************/
    const QUESTIONS = ENHANCED_QUESTIONS;
    console.log('Questions loaded:', QUESTIONS.length);
    console.log('Subjects available:', [...new Set(QUESTIONS.map(q => q.subject))]);
    /****************************************************************/

    // DOM refs
    const subjectsList = document.getElementById('subjectsList');
    const yearSelect = document.getElementById('yearSelect');
    const startBtn = document.getElementById('startBtn');
    const modeSelect = document.getElementById('modeSelect');
    const endlessMode = document.getElementById('endlessMode');
    const dashboardBtn = document.getElementById('dashboardBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // initialize
    function init(){
      console.log('Initializing quiz page with questions:', QUESTIONS.length);
      populateYears();
      renderSubjects();
      bindEvents();
    }

    function populateYears(){
      const years = Array.from(new Set(QUESTIONS.map(q => q.year))).sort((a, b) => b - a);
      console.log('Available years:', years);
      yearSelect.innerHTML = '<option value="all">All years</option>';
      for(const y of years){
        const o = document.createElement('option'); 
        o.value = y; 
        o.textContent = y; 
        yearSelect.appendChild(o);
      }
    }

    function renderSubjects(){
      const subjects = Array.from(new Set(QUESTIONS.map(q => q.subject))).sort();
      console.log('Rendering subjects:', subjects);
      subjectsList.innerHTML = '';
      
      if (subjects.length === 0) {
        subjectsList.innerHTML = '<p style="color: var(--muted); text-align: center;">No subjects found</p>';
        return;
      }
      
      for(const t of subjects){
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = t;
        chip.setAttribute('data-subject', t);
        chip.addEventListener('click', () => {
          chip.classList.toggle('active');
        });
        subjectsList.appendChild(chip);
      }
    }

    function bindEvents(){
      startBtn.addEventListener('click', startQuiz);
      dashboardBtn.addEventListener('click', () => {
        window.location.href = 'dashboard.html';
      });
      logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => {
          window.location.href = 'index.html';
        });
      });
    }

    function startQuiz(){
      const selectedSubjects = Array.from(document.querySelectorAll('.chip.active')).map(c => c.dataset.subject);
      const year = yearSelect.value;
      const mode = modeSelect.value;
      const endless = endlessMode.checked;

      if (selectedSubjects.length === 0) {
        alert('Please select at least one subject');
        return;
      }

      // NEW: Clear any previous quiz session
      sessionStorage.removeItem('current_quiz_answers');
      sessionStorage.removeItem('current_quiz_progress');

      // Store filter settings in localStorage (this is okay - it's user preference)
      const filterSettings = {
        selectedSubjects,
        year,
        mode,
        endless
      };
      
      localStorage.setItem('bece_filter_settings', JSON.stringify(filterSettings));
      
      // Redirect to quiz page
      window.location.href = 'qna.html';
    }

    // Protect route - redirect if not authenticated, otherwise init app
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        console.log("Logged in:", user.email);
        // Initialize after auth is confirmed
        init();
      }
    });
  </script>
</body>
</html>