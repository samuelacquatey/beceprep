<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BECE Past Questions — Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">BE</div>
        <div>
          <h1>BECE Prep [Interactive MVP]</h1>
          <p class="lead">Practice by subject or year • Get performance analytics and improvement tips</p>
        </div>
      </div>
      <div>
        <button id="backBtn" class="btn ghost">Change Filters</button>
        <button id="dashboardBtn" class="btn ghost">View Analytics</button>
        <button id="exportBtn" class="btn ghost">Export Answers</button>
      </div>
    </header>

    <div class="grid">
      <aside class="sidebar card">
        <div class="section">
          <h3>Current Filters</h3>
          <div id="currentFilters" style="color:var(--muted);font-size:13px;margin-bottom:12px"></div>
        </div>

        <div class="section">
          <h3>Controls</h3>
          <div class="controls">
            <button id="restartBtn" class="btn">Restart</button>
          </div>
        </div>

        <div class="section">
          <h3>Progress</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <div class="progress" aria-hidden><i id="progressBar" style="width:0%"></i></div>
            </div>
            <div id="progressLabel" style="min-width:70px;text-align:right;color:var(--muted)">0 / 0</div>
          </div>
        </div>

        <div class="section">
          <h3>Quick stats</h3>
          <div class="results" id="statsArea">
            <div class="stat">Answered: <strong id="answeredCount">0</strong></div>
            <div class="stat">Correct: <strong id="correctCount">0</strong></div>
            <div class="stat">Accuracy: <strong id="accuracy">0%</strong></div>
          </div>
        </div>

        <div class="section">
          <h3>Saved Sessions</h3>
          <div id="sessionsList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
      </aside>

      <main class="main">
        <div class="question-card card" id="questionCard">
          <div class="meta">
            <div id="metaLeft">Loading questions...</div>
            <div id="metaRight"></div>
          </div>

          <div style="margin-top:10px">
            <div class="prompt" id="prompt">—</div>
            <div class="options" id="options"></div>
          </div>

          <div class="actions">
            <div style="display:flex;gap:8px">
              <button class="btn ghost" id="prevBtn">Previous</button>
              <button class="btn ghost" id="nextBtn">Skip</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="submitBtn">Submit</button>
              <button class="btn ghost" id="reviewBtn">Summary</button>
            </div>
          </div>
        </div>

        <div class="confidence-rating" id="confidenceRating">
          <h4>How confident are you in your answer?</h4>
          <div class="confidence-buttons">
            <button class="btn ghost confidence-btn" data-level="0.2">Not Sure</button>
            <button class="btn ghost confidence-btn" data-level="0.5">Somewhat Sure</button>
            <button class="btn ghost confidence-btn" data-level="0.8">Confident</button>
            <button class="btn ghost confidence-btn" data-level="1.0">Very Confident</button>
          </div>
        </div>

        <div class="card" id="summaryPanel" style="display:none">
          <h3>Session summary</h3>
          <div id="summaryContent"></div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="closeSummary">Close</button>
            <button class="btn" id="clearSession">Clear answers</button>
          </div>
        </div>

        <footer class="small">This is a front-end MVP with dummy questions. Answers are stored in your browser's localStorage.</footer>
      </main>
    </div>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { trackQuestionAttempt } from "./js/database.js";
    import { app } from "./js/auth.js";

    const auth = getAuth(app);

    /*********************** Enhanced Question Dataset ************************/
    const QUESTIONS = [
      {
        id: 1, year: 2019, subject: 'Mathematics', topic: 'algebraic expressions', 
        subtopic: 'Linear Equations', difficulty: 'medium',
        q: 'Simplify: 3(x+4) - 2x', 
        options: ['x+12', 'x+4', '5x+12', 'x+8'], 
        a: 0
      },
      {
        id: 2, year: 2019, subject: 'English', topic: 'grammar', 
        subtopic: 'Verb Tenses', difficulty: 'easy',
        q: 'Choose the correct sentence', 
        options: ['He dont like it', 'He does not like it', 'He do not like it', 'He not like it'], 
        a: 1
      },
      {
        id: 3, year: 2020, subject: 'Integrated Science', topic: 'plant biology', 
        subtopic: 'Photosynthesis', difficulty: 'medium',
        q: 'Which gas do plants consume?', 
        options: ['Oxygen', 'Nitrogen', 'Carbon dioxide', 'Helium'], 
        a: 2
      },
      {
        id: 4, year: 2020, subject: 'Mathematics', topic: 'sequences', 
        subtopic: 'Geometric Sequences', difficulty: 'medium',
        q: 'What is the next number: 2,4,8,16,...', 
        options: ['20', '24', '32', '34'], 
        a: 2
      },
      {
        id: 5, year: 2021, subject: 'Social Studies', topic: 'civics', 
        subtopic: 'Government Systems', difficulty: 'easy',
        q: 'What is a democracy?', 
        options: ['One-man rule', 'Rule by the people', 'Military rule', 'A type of crop'], 
        a: 1
      },
      {
        id: 6, year: 2021, subject: 'Mathematics', topic: 'algebra', 
        subtopic: 'Linear Equations', difficulty: 'easy',
        q: 'Solve for x: 2x = 10', 
        options: ['4', '5', '10', '8'], 
        a: 1
      },
      {
        id: 7, year: 2022, subject: 'English', topic: 'vocabulary', 
        subtopic: 'Synonyms', difficulty: 'easy',
        q: 'Pick the synonym for "happy"', 
        options: ['Sad', 'Angry', 'Glad', 'Tired'], 
        a: 2
      },
      {
        id: 8, year: 2022, subject: 'Integrated Science', topic: 'measurement', 
        subtopic: 'Scientific Instruments', difficulty: 'easy',
        q: 'Which device measures temperature?', 
        options: ['Barometer', 'Thermometer', 'Ammeter', 'Voltmeter'], 
        a: 1
      },
      {
        id: 9, year: 2023, subject: 'Mathematics', topic: 'geometry', 
        subtopic: 'Area Calculation', difficulty: 'medium',
        q: 'Find area of rectangle with sides 4 and 6', 
        options: ['10', '24', '12', '20'], 
        a: 1
      },
      {
        id: 10, year: 2023, subject: 'Social Studies', topic: 'geography', 
        subtopic: 'African Capitals', difficulty: 'easy',
        q: 'Capital city of Ghana', 
        options: ['Kumasi', 'Accra', 'Tamale', 'Takoradi'], 
        a: 1
      },
      {
        id: 11, year: 2022, subject: 'Mathematics', topic: 'fractions', 
        subtopic: 'Basic Operations', difficulty: 'medium',
        q: 'What is 1/2 + 1/4?', 
        options: ['1/6', '2/6', '3/4', '2/8'], 
        a: 2
      },
      {
        id: 12, year: 2021, subject: 'English', topic: 'comprehension', 
        subtopic: 'Reading Skills', difficulty: 'hard',
        q: 'What is the main idea of a story?', 
        options: ['The first sentence', 'The central message', 'The characters', 'The setting'], 
        a: 1
      }
    ];
    /****************************************************************/

    // App state
    let state = {
      pool: [], // filtered question ids
      index: 0, // current index in pool
      mode: 'practice',
      endless: false,
      answers: {}, // {questionId: {choice: i, correct: bool, time: ts}}
      filterSettings: null,
      sessionId: generateSessionId(),
      startTime: null,
      currentQuestionStart: null,
      userConfidence: null
    };

    // DOM refs
    const backBtn = document.getElementById('backBtn');
    const dashboardBtn = document.getElementById('dashboardBtn');
    const restartBtn = document.getElementById('restartBtn');
    const currentFilters = document.getElementById('currentFilters');
    const promptEl = document.getElementById('prompt');
    const optionsEl = document.getElementById('options');
    const metaLeft = document.getElementById('metaLeft');
    const metaRight = document.getElementById('metaRight');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const reviewBtn = document.getElementById('reviewBtn');
    const progressBar = document.getElementById('progressBar');
    const progressLabel = document.getElementById('progressLabel');
    const answeredCount = document.getElementById('answeredCount');
    const correctCount = document.getElementById('correctCount');
    const accuracy = document.getElementById('accuracy');
    const summaryPanel = document.getElementById('summaryPanel');
    const summaryContent = document.getElementById('summaryContent');
    const closeSummary = document.getElementById('closeSummary');
    const clearSession = document.getElementById('clearSession');
    const sessionsList = document.getElementById('sessionsList');
    const exportBtn = document.getElementById('exportBtn');
    const confidenceRating = document.getElementById('confidenceRating');

    // initialize
    function init(){
      // Load filter settings from localStorage
      const filterSettings = localStorage.getItem('bece_filter_settings');
      if (!filterSettings) {
        window.location.href = 'index.html';
        return;
      }
      
      state.filterSettings = JSON.parse(filterSettings);
      displayCurrentFilters();
      loadSavedSession();
      startSession();
      bindEvents();
      updateStats();
    }

    function displayCurrentFilters() {
      let filterText = '';
      
      if (state.filterSettings.year !== 'all') {
        filterText += `Year: ${state.filterSettings.year}<br>`;
      }
      
      if (state.filterSettings.selectedSubjects.length > 0) {
        filterText += `Subjects: ${state.filterSettings.selectedSubjects.join(', ')}<br>`;
      }
      
      filterText += `Mode: ${state.filterSettings.mode === 'practice' ? 'Practice' : 'Exam'}<br>`;
      filterText += `Endless: ${state.filterSettings.endless ? 'On' : 'Off'}`;
      
      currentFilters.innerHTML = filterText;
    }

    function startSession(){
      const selectedSubjects = state.filterSettings.selectedSubjects;
      const year = state.filterSettings.year;
      state.mode = state.filterSettings.mode;
      state.endless = state.filterSettings.endless;

      state.pool = QUESTIONS.filter(q => {
        if(selectedSubjects.length && !selectedSubjects.includes(q.subject)) return false;
        if(year !== 'all' && String(q.year) !== String(year)) return false;
        return true;
      }).map(q => q.id);

      if(state.pool.length === 0){
        promptEl.textContent = 'No questions match your filters.';
        optionsEl.innerHTML = '';
        metaLeft.textContent = '—';
        metaRight.textContent = '';
        return;
      }
      
      state.index = 0;
      state.startTime = Date.now();
      renderQuestion();
      updateProgress();
    }

    function renderQuestion(){
      if(state.pool.length === 0){ 
        promptEl.textContent = 'No active session. Choose filters and press Start.'; 
        optionsEl.innerHTML = ''; 
        metaLeft.textContent = '—'; 
        metaRight.textContent = ''; 
        return; 
      }
      
      const qid = state.pool[state.index];
      const q = QUESTIONS.find(x => x.id === qid);
      metaLeft.textContent = `${q.subject} • ${q.topic} • ${q.year}`;
      metaRight.textContent = `Question ${state.index + 1} of ${state.pool.length}`;
      promptEl.textContent = q.q;

      optionsEl.innerHTML = '';
      q.options.forEach((opt, i) => {
        const el = document.createElement('div');
        el.className = 'option';
        el.tabIndex = 0;
        el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><span>${String.fromCharCode(65 + i)}. ${opt}</span></div>`;
        el.addEventListener('click', () => {
          selectOption(q.id, i);
          // Show confidence rating after selection
          confidenceRating.style.display = 'block';
        });
        optionsEl.appendChild(el);
      });

      // Hide confidence rating when moving to new question
      confidenceRating.style.display = 'none';
      
      // restore selection if any
      const prev = state.answers[q.id];
      if(prev) {
        const nodes = optionsEl.querySelectorAll('.option');
        nodes[prev.choice].classList.add('selected');
        if(state.mode === 'practice') showCorrectness(q.id);
      }
      
      // Start timing for this question
      state.currentQuestionStart = Date.now();
      state.userConfidence = null;
    }

    function selectOption(qid, choice){
      // toggle selection
      const nodes = optionsEl.querySelectorAll('.option');
      nodes.forEach(n => n.classList.remove('selected'));
      nodes[choice].classList.add('selected');
      // store temporarily, not marking correct until submit
      state.answers[qid] = state.answers[qid] || {};
      state.answers[qid].choice = choice;
      saveSession();
      updateStats();
    }

    async function submitAnswer(){
      if(state.pool.length === 0) return;
      const qid = state.pool[state.index];
      const q = QUESTIONS.find(x => x.id === qid);
      const record = state.answers[qid];
      
      if(!record || typeof record.choice !== 'number'){ 
        alert('Please select an option first.'); 
        return; 
      }
      
      const timeSpent = Math.round((Date.now() - state.currentQuestionStart) / 1000);
      const correct = (record.choice === q.a);
      
      // Update record with final data
      record.correct = correct;
      record.time = Date.now();
      record.timeSpent = timeSpent;
      record.confidence = state.userConfidence || 0.5;
      
      // Enhanced tracking data for analytics
      const trackingData = {
        choice: record.choice,
        timeSpent: timeSpent,
        confidence: state.userConfidence || 0.5,
        sessionId: state.sessionId,
        mode: state.mode,
        timestamp: new Date(),
        isCorrect: correct
      };
      
      // Track in Firebase if user is logged in
      const user = auth.currentUser;
      if (user) {
        try {
          await trackQuestionAttempt(user.uid, q, trackingData);
        } catch (error) {
          console.log('Analytics tracking failed, continuing without:', error);
        }
      }
      
      saveSession();
      if(state.mode === 'practice') showCorrectness(qid);
      updateStats();

      // Reset confidence for next question
      state.userConfidence = null;
      confidenceRating.style.display = 'none';

      // auto-advance
      if(state.index < state.pool.length - 1) {
        nextQuestion();
      } else if(state.endless) {
        // shuffle to a random question
        state.index = Math.floor(Math.random() * state.pool.length);
        renderQuestion();
      }
    }

    function showCorrectness(qid){
      const q = QUESTIONS.find(x => x.id === qid);
      const nodes = optionsEl.querySelectorAll('.option');
      nodes.forEach((n, i) => {
        n.classList.remove('correct', 'wrong');
        if(i === q.a) n.classList.add('correct');
        const rec = state.answers[qid];
        if(rec && rec.choice === i && rec.choice !== q.a) n.classList.add('wrong');
      });
    }

    function prevQuestion(){
      if(state.pool.length === 0) return;
      state.index = Math.max(0, state.index - 1);
      renderQuestion();
      updateProgress();
    }

    function nextQuestion(){
      if(state.pool.length === 0) return;
      state.index = Math.min(state.pool.length - 1, state.index + 1);
      renderQuestion();
      updateProgress();
    }

    function updateProgress(){
      const total = state.pool.length;
      const done = state.pool.filter(id => state.answers[id] && typeof state.answers[id].choice === 'number').length;
      progressBar.style.width = total ? Math.round((done / total) * 100) + '%' : '0%';
      progressLabel.textContent = `${done} / ${total}`;
    }

    function updateStats(){
      const answered = Object.keys(state.answers).length;
      const correct = Object.values(state.answers).filter(r => r.correct).length;
      answeredCount.textContent = answered;
      correctCount.textContent = correct;
      accuracy.textContent = answered ? Math.round((correct / answered) * 100) + '%' : '0%';
      updateProgress();
      renderSavedSessionsList();
    }

    function saveSession(){
      localStorage.setItem('bece_mvp_answers', JSON.stringify(state.answers));
    }

    function loadSavedSession(){
      const raw = localStorage.getItem('bece_mvp_answers');
      if(raw) state.answers = JSON.parse(raw);
    }

    function renderSavedSessionsList(){
      sessionsList.innerHTML = '';
      const raw = localStorage.getItem('bece_mvp_answers');
      if(raw){
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';
        div.innerHTML = `<small style="color:var(--muted)">Local session saved</small><div><button class='btn ghost load-session' data-session='local'>Load</button></div>`;
        sessionsList.appendChild(div);
      } else {
        sessionsList.innerHTML = '<small style="color:var(--muted)">No saved sessions</small>';
      }
    }

    function loadSession(name){
      if(name === 'local') loadSavedSession();
      updateStats(); 
      renderQuestion();
    }

    function showSummary(){
      summaryPanel.style.display = 'block';
      const answeredIds = Object.keys(state.answers).map(x => Number(x));
      if(answeredIds.length === 0) { 
        summaryContent.innerHTML = '<p style="color:var(--muted)">No answers yet. Start a session and submit answers.</p>'; 
        return; 
      }

      // Build per-subject summary
      const bySubject = {};
      for(const id of answeredIds){
        const q = QUESTIONS.find(x => x.id === id);
        const rec = state.answers[id];
        bySubject[q.subject] = bySubject[q.subject] || {correct: 0, total: 0, items: []};
        bySubject[q.subject].total += 1;
        if(rec.correct) bySubject[q.subject].correct += 1;
        bySubject[q.subject].items.push({q, rec});
      }

      let html = '<div style="display:flex;flex-direction:column;gap:8px">';
      for(const t of Object.keys(bySubject)){
        const s = bySubject[t];
        const perc = Math.round((s.correct / s.total) * 100);
        html += `<div style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)"><strong>${t}</strong> — ${s.correct}/${s.total} correct (${perc}%)</div>`;
      }
      html += '</div>';
      summaryContent.innerHTML = html;
    }

    function clearAll(){ 
      localStorage.removeItem('bece_mvp_answers'); 
      state.answers = {}; 
      updateStats(); 
      renderQuestion(); 
    }

    function exportAnswers(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(20);
      doc.setTextColor(61, 61, 139);
      doc.text("BECE Exam Results Summary", 105, 20, { align: "center" });
      
      // Add date
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: "center" });
      
      // Add summary statistics
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text("Performance Summary", 20, 45);
      
      doc.setFontSize(12);
      const answered = Object.keys(state.answers).length;
      const correct = Object.values(state.answers).filter(r => r.correct).length;
      const accuracy = answered ? Math.round((correct / answered) * 100) : 0;
      
      doc.text(`Questions Answered: ${answered}`, 20, 55);
      doc.text(`Correct Answers: ${correct}`, 20, 65);
      doc.text(`Accuracy: ${accuracy}%`, 20, 75);
      
      // Add subject breakdown
      doc.setFontSize(14);
      doc.text("Subject Performance", 20, 90);
      
      const bySubject = {};
      for(const id of Object.keys(state.answers)){
        const q = QUESTIONS.find(x => x.id === parseInt(id));
        if (q) {
          bySubject[q.subject] = bySubject[q.subject] || {correct: 0, total: 0};
          bySubject[q.subject].total += 1;
          if(state.answers[id].correct) bySubject[q.subject].correct += 1;
        }
      }
      
      let yPos = 100;
      doc.setFontSize(12);
      for(const subject of Object.keys(bySubject)){
        const s = bySubject[subject];
        const perc = Math.round((s.correct / s.total) * 100);
        doc.text(`${subject}: ${s.correct}/${s.total} (${perc}%)`, 20, yPos);
        yPos += 10;
      }
      
      // Add detailed answers
      doc.setFontSize(14);
      yPos += 10;
      doc.text("Detailed Answers", 20, yPos);
      yPos += 15;
      
      doc.setFontSize(10);
      for(const id of Object.keys(state.answers)){
        const q = QUESTIONS.find(x => x.id === parseInt(id));
        if (q) {
          const answer = state.answers[id];
          
          // Check if we need a new page
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
          }
          
          doc.setFontSize(10);
          doc.setTextColor(0, 0, 0);
          doc.text(`Q: ${q.q}`, 20, yPos);
          yPos += 7;
          
          doc.setTextColor(0, 0, 0);
          doc.text(`Your answer: ${q.options[answer.choice]}`, 20, yPos);
          yPos += 7;
          
          if (answer.correct) {
            doc.setTextColor(0, 128, 0);
            doc.text("✓ Correct", 20, yPos);
          } else {
            doc.setTextColor(255, 0, 0);
            doc.text(`✗ Incorrect (Correct: ${q.options[q.a]})`, 20, yPos);
          }
          yPos += 12;
        }
      }
      
      // Save the PDF
      doc.save("bece_exam_results.pdf");
    }

    function bindEvents(){
      prevBtn.addEventListener('click', prevQuestion);
      nextBtn.addEventListener('click', nextQuestion);
      submitBtn.addEventListener('click', submitAnswer);
      reviewBtn.addEventListener('click', showSummary);
      closeSummary.addEventListener('click', () => summaryPanel.style.display = 'none');
      clearSession.addEventListener('click', () => { 
        if(confirm('Clear saved answers?')){ 
          state.answers = {}; 
          saveSession(); 
          updateStats(); 
          renderQuestion(); 
        }
      });
      exportBtn.addEventListener('click', exportAnswers);
      sessionsList.addEventListener('click', (e) => { 
        if(e.target.matches('.load-session')) loadSession(e.target.dataset.session); 
      });
      backBtn.addEventListener('click', () => { 
        window.location.href = 'quiz.html'; 
      });
      dashboardBtn.addEventListener('click', () => {
        window.location.href = 'dashboard.html';
      });
      restartBtn.addEventListener('click', () => { 
        state.answers = {};
        saveSession();
        state.index = 0;
        updateStats();
        renderQuestion();
      });

      // Confidence button handlers
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('confidence-btn')) {
          state.userConfidence = parseFloat(e.target.dataset.level);
          submitAnswer(); // Auto-submit after confidence selection
        }
      });
    }

    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Protect route - redirect if not authenticated
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        console.log("Logged in:", user.email);
        init();
      }
    });
  </script>
</body>
</html>