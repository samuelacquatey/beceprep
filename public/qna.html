<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BECE Past Questions â€” Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">BE</div>
        <div>
          <h1>BECE Prep [Interactive MVP]</h1>
          <p class="lead">Practice by subject or year â€¢ Get performance analytics and improvement tips</p>
        </div>
      </div>
      <div>
        <button id="backBtn" class="btn ghost">Change Filters</button>
        <button id="dashboardBtn" class="btn ghost">ðŸ“Š Analytics</button>
        <button id="socialBtn" class="btn ghost">ðŸ‘¥ Social Hub</button>
        <button id="flashcardsBtn" class="btn ghost">ðŸŽ´ Flashcards</button>
        <button id="exportBtn" class="btn ghost">Export Answers</button>
      </div>
    </header>

    <div class="grid">
      <aside class="sidebar card">
        <div class="section">
          <h3>Current Filters</h3>
          <div id="currentFilters" style="color:var(--muted);font-size:13px;margin-bottom:12px"></div>
        </div>

        <div class="section">
          <h3>Controls</h3>
          <div class="controls">
            <button id="restartBtn" class="btn">Restart</button>
          </div>
        </div>

        <div class="section">
          <h3>Progress</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <div class="progress" aria-hidden><i id="progressBar" style="width:0%"></i></div>
            </div>
            <div id="progressLabel" style="min-width:70px;text-align:right;color:var(--muted)">0 / 0</div>
          </div>
        </div>

        <div class="section">
          <h3>Quick stats</h3>
          <div class="results" id="statsArea">
            <div class="stat">Answered: <strong id="answeredCount">0</strong></div>
            <div class="stat">Correct: <strong id="correctCount">0</strong></div>
            <div class="stat">Accuracy: <strong id="accuracy">0%</strong></div>
          </div>
        </div>

        <div class="section">
          <h3>Saved Sessions</h3>
          <div id="sessionsList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
      </aside>

      <main class="main">
        <div class="question-card card" id="questionCard">
          <div class="meta">
            <div id="metaLeft">Loading questions...</div>
            <div id="metaRight"></div>
          </div>

          <div style="margin-top:10px">
            <div class="prompt" id="prompt">â€”</div>
            <div class="options" id="options"></div>
          </div>

          <div class="actions">
            <div style="display:flex;gap:8px">
              <button class="btn ghost" id="prevBtn">Previous</button>
              <button class="btn ghost" id="nextBtn">Next</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="submitBtn">Submit</button>
              <button class="btn ghost" id="reviewBtn">Summary</button>
            </div>
          </div>
        </div>

        <div class="confidence-rating" id="confidenceRating">
          <h4>How confident are you in your answer?</h4>
          <div class="confidence-buttons">
            <button class="btn ghost confidence-btn" data-level="0.2">Not Sure</button>
            <button class="btn ghost confidence-btn" data-level="0.5">Somewhat Sure</button>
            <button class="btn ghost confidence-btn" data-level="0.8">Confident</button>
            <button class="btn ghost confidence-btn" data-level="1.0">Very Confident</button>
          </div>
        </div>

        <div class="card" id="summaryPanel" style="display:none">
          <h3>Session summary</h3>
          <div id="summaryContent"></div>
          </p>';
          return;
          }

          // Build per-subject summary
          const bySubject = {};
          for(const id of answeredIds){
          const q = QUESTIONS.find(x => x.id === id);
          const rec = state.answers[id];
          bySubject[q.subject] = bySubject[q.subject] || {correct: 0, total: 0, items: []};
          bySubject[q.subject].total += 1;
          if(rec.correct) bySubject[q.subject].correct += 1;
          bySubject[q.subject].items.push({q, rec});
          }

          let html = '<div style="display:flex;flex-direction:column;gap:8px">';
            for(const t of Object.keys(bySubject)){
            const s = bySubject[t];
            const perc = Math.round((s.correct / s.total) * 100);
            html += `<div style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)"><strong>${t}</strong>
              â€”
              ${s.correct}/${s.total} correct (${perc}%)</div>`;
            }
            html += '</div>';
          summaryContent.innerHTML = html;
          }

          function clearAll(){
          sessionStorage.removeItem('current_quiz_answers');
          sessionStorage.removeItem('current_quiz_progress');
          state.answers = {};
          updateStats();
          renderQuestion();
          }

          function exportAnswers(){
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Add title
          doc.setFontSize(20);
          doc.setTextColor(61, 61, 139);
          doc.text("BECE Exam Results Summary", 105, 20, { align: "center" });

          // Add date
          doc.setFontSize(12);
          doc.setTextColor(100, 100, 100);
          doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: "center" });

          // Add summary statistics
          doc.setFontSize(14);
          doc.setTextColor(0, 0, 0);
          doc.text("Performance Summary", 20, 45);

          doc.setFontSize(12);
          const answered = Object.keys(state.answers).length;
          const correct = Object.values(state.answers).filter(r => r.correct).length;
          const accuracy = answered ? Math.round((correct / answered) * 100) : 0;

          doc.text(`Questions Answered: ${answered}`, 20, 55);
          doc.text(`Correct Answers: ${correct}`, 20, 65);
          doc.text(`Accuracy: ${accuracy}%`, 20, 75);

          // Add subject breakdown
          doc.setFontSize(14);
          doc.text("Subject Performance", 20, 90);

          const bySubject = {};
          for(const id of Object.keys(state.answers)){
          const q = QUESTIONS.find(x => x.id === parseInt(id));
          if (q) {
          bySubject[q.subject] = bySubject[q.subject] || {correct: 0, total: 0};
          bySubject[q.subject].total += 1;
          if(state.answers[id].correct) bySubject[q.subject].correct += 1;
          }
          }

          let yPos = 100;
          doc.setFontSize(12);
          for(const subject of Object.keys(bySubject)){
          const s = bySubject[subject];
          const perc = Math.round((s.correct / s.total) * 100);
          doc.text(`${subject}: ${s.correct}/${s.total} (${perc}%)`, 20, yPos);
          yPos += 10;
          }

          // Add detailed answers
          doc.setFontSize(14);
          yPos += 10;
          doc.text("Detailed Answers", 20, yPos);
          yPos += 15;

          doc.setFontSize(10);
          for(const id of Object.keys(state.answers)){
          const q = QUESTIONS.find(x => x.id === parseInt(id));
          if (q) {
          const answer = state.answers[id];

          // Check if we need a new page
          if (yPos > 250) {
          doc.addPage();
          yPos = 20;
          }

          doc.setFontSize(10);
          doc.setTextColor(0, 0, 0);
          doc.text(`Q: ${q.q}`, 20, yPos);
          yPos += 7;

          doc.setTextColor(0, 0, 0);
          doc.text(`Your answer: ${q.options[answer.choice]}`, 20, yPos);
          yPos += 7;

          if (answer.correct) {
          doc.setTextColor(0, 128, 0);
          doc.text("âœ“ Correct", 20, yPos);
          } else {
          doc.setTextColor(255, 0, 0);
          doc.text(`âœ— Incorrect (Correct: ${q.options[q.a]})`, 20, yPos);
          }
          yPos += 12;
          }
          }

          // Save the PDF
          doc.save("bece_exam_results.pdf");
          }

          function bindEvents(){
          prevBtn.addEventListener('click', prevQuestion);
          nextBtn.addEventListener('click', nextQuestion);
          submitBtn.addEventListener('click', submitAnswer);
          reviewBtn.addEventListener('click', showSummary);
          closeSummary.addEventListener('click', () => summaryPanel.style.display = 'none');
          clearSession.addEventListener('click', () => {
          if(confirm('Clear saved answers?')){
          state.answers = {};
          saveSession();
          updateStats();
          renderQuestion();
          }
          });
          exportBtn.addEventListener('click', exportAnswers);
          sessionsList.addEventListener('click', (e) => {
          if(e.target.matches('.load-session')) loadSession(e.target.dataset.session);
          });
          backBtn.addEventListener('click', () => {
          cleanupSession();
          window.location.href = 'quiz.html';
          });
          dashboardBtn.addEventListener('click', () => {
          cleanupSession();
          window.location.href = 'dashboard.html';
          });
          restartBtn.addEventListener('click', () => {
          state.answers = {};
          saveSession();
          state.index = 0;
          updateStats();
          renderQuestion();
          });

          // Confidence button handlers
          document.addEventListener('click', function(e) {
          if (e.target.classList.contains('confidence-btn')) {
          state.userConfidence = parseFloat(e.target.dataset.level);
          submitAnswer(); // Auto-submit after confidence selection
          }
          });
          }

          function generateSessionId() {
          <button class="btn ghost" id="prevBtn">Previous</button>
          <button class="btn ghost" id="nextBtn">Next</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="submitBtn">Submit</button>
          <button class="btn ghost" id="reviewBtn">Summary</button>
        </div>
    </div>
  </div>

  <div class="confidence-rating" id="confidenceRating">
    <h4>How confident are you in your answer?</h4>
    <div class="confidence-buttons">
      <button class="btn ghost confidence-btn" data-level="0.2">Not Sure</button>
      <button class="btn ghost confidence-btn" data-level="0.5">Somewhat Sure</button>
      <button class="btn ghost confidence-btn" data-level="0.8">Confident</button>
      <button class="btn ghost confidence-btn" data-level="1.0">Very Confident</button>
    </div>
  </div>

  <div class="card" id="summaryPanel" style="display:none">
    <h3>Session summary</h3>
    <div id="summaryContent"></div>
    </p>';
    return;
    }

    // Build per-subject summary
    const bySubject = {};
    for(const id of answeredIds){
    const q = QUESTIONS.find(x => x.id === id);
    const rec = state.answers[id];
    bySubject[q.subject] = bySubject[q.subject] || {correct: 0, total: 0, items: []};
    bySubject[q.subject].total += 1;
    if(rec.correct) bySubject[q.subject].correct += 1;
    bySubject[q.subject].items.push({q, rec});
    }

    let html = '<div style="display:flex;flex-direction:column;gap:8px">';
      for(const t of Object.keys(bySubject)){
      const s = bySubject[t];
      const perc = Math.round((s.correct / s.total) * 100);
      html += `<div style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)"><strong>${t}</strong>
        â€”
        ${s.correct}/${s.total} correct (${perc}%)</div>`;
      }
      html += '</div>';
    summaryContent.innerHTML = html;
    }

    function clearAll(){
    sessionStorage.removeItem('current_quiz_answers');
    sessionStorage.removeItem('current_quiz_progress');
    state.answers = {};
    updateStats();
    renderQuestion();
    }

    function exportAnswers(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Add title
    doc.setFontSize(20);
    doc.setTextColor(61, 61, 139);
    doc.text("BECE Exam Results Summary", 105, 20, { align: "center" });

    // Add date
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: "center" });

    // Add summary statistics
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text("Performance Summary", 20, 45);

    doc.setFontSize(12);
    const answered = Object.keys(state.answers).length;
    const correct = Object.values(state.answers).filter(r => r.correct).length;
    const accuracy = answered ? Math.round((correct / answered) * 100) : 0;

    doc.text(`Questions Answered: ${answered}`, 20, 55);
    doc.text(`Correct Answers: ${correct}`, 20, 65);
    doc.text(`Accuracy: ${accuracy}%`, 20, 75);

    // Add subject breakdown
    doc.setFontSize(14);
    doc.text("Subject Performance", 20, 90);

    const bySubject = {};
    for(const id of Object.keys(state.answers)){
    const q = QUESTIONS.find(x => x.id === parseInt(id));
    if (q) {
    bySubject[q.subject] = bySubject[q.subject] || {correct: 0, total: 0};
    bySubject[q.subject].total += 1;
    if(state.answers[id].correct) bySubject[q.subject].correct += 1;
    }
    }

    let yPos = 100;
    doc.setFontSize(12);
    for(const subject of Object.keys(bySubject)){
    const s = bySubject[subject];
    const perc = Math.round((s.correct / s.total) * 100);
    doc.text(`${subject}: ${s.correct}/${s.total} (${perc}%)`, 20, yPos);
    yPos += 10;
    }

    // Add detailed answers
    doc.setFontSize(14);
    yPos += 10;
    doc.text("Detailed Answers", 20, yPos);
    yPos += 15;

    doc.setFontSize(10);
    for(const id of Object.keys(state.answers)){
    const q = QUESTIONS.find(x => x.id === parseInt(id));
    if (q) {
    const answer = state.answers[id];

    // Check if we need a new page
    if (yPos > 250) {
    doc.addPage();
    yPos = 20;
    }

    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.text(`Q: ${q.q}`, 20, yPos);
    yPos += 7;

    doc.setTextColor(0, 0, 0);
    doc.text(`Your answer: ${q.options[answer.choice]}`, 20, yPos);
    yPos += 7;

    if (answer.correct) {
    doc.setTextColor(0, 128, 0);
    doc.text("âœ“ Correct", 20, yPos);
    } else {
    doc.setTextColor(255, 0, 0);
    doc.text(`âœ— Incorrect (Correct: ${q.options[q.a]})`, 20, yPos);
    }
    yPos += 12;
    }
    }

    // Save the PDF
    doc.save("bece_exam_results.pdf");
    }

    function bindEvents(){
    prevBtn.addEventListener('click', prevQuestion);
    nextBtn.addEventListener('click', nextQuestion);
    submitBtn.addEventListener('click', submitAnswer);
    reviewBtn.addEventListener('click', showSummary);
    closeSummary.addEventListener('click', () => summaryPanel.style.display = 'none');
    clearSession.addEventListener('click', () => {
    if(confirm('Clear saved answers?')){
    state.answers = {};
    saveSession();
    updateStats();
    renderQuestion();
    }
    });
    exportBtn.addEventListener('click', exportAnswers);
    sessionsList.addEventListener('click', (e) => {
    if(e.target.matches('.load-session')) loadSession(e.target.dataset.session);
    });
    backBtn.addEventListener('click', () => {
    cleanupSession();
    window.location.href = 'quiz.html';
    });
    dashboardBtn.addEventListener('click', () => {
    cleanupSession();
    window.location.href = 'dashboard.html';
    });
    restartBtn.addEventListener('click', () => {
    state.answers = {};
    saveSession();
    state.index = 0;
    updateStats();
    renderQuestion();
    });

    // Confidence button handlers
    document.addEventListener('click', function(e) {
    if (e.target.classList.contains('confidence-btn')) {
    state.userConfidence = parseFloat(e.target.dataset.level);
    submitAnswer(); // Auto-submit after confidence selection
    }
    });
    }

    function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Protect route - redirect if not authenticated
    onAuthStateChanged(auth, (user) => {
    if (!user) {
    window.location.href = "index.html";
    } else {
    console.log("Logged in:", user.email);
    init();
    }
    });
    </script>
</body>

</html>