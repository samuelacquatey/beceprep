<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BECE Prep - Analytics Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/dashboard-modern.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- Header -->

  <div class="dashboard-container">
    <!-- 1. Left Sidebar -->
    <nav class="sidebar">
      <div class="brand-icon">‚ö°</div>
      <div class="nav-item active"><i class="fas fa-home"></i></div>
      <div class="nav-item" onclick="window.location.href='quiz.html'" title="Quiz"><i class="fas fa-book-open"></i>
      </div>
      <div class="nav-item" onclick="window.location.href='social.html'" title="Social"><i
          class="fas fa-user-friends"></i></div>
      <div class="nav-item" onclick="window.location.href='flashcards.html'" title="Flashcards"><i
          class="fas fa-layer-group"></i></div>
      <div class="nav-item" style="margin-top: auto;" id="logoutBtn" title="Logout"><i class="fas fa-sign-out-alt"></i>
      </div>
    </nav>

    <!-- 2. Main Content -->
    <main class="main-content">
      <!-- Header -->
      <header class="header">
        <h1>Dashboard</h1>
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <span>Search...</span>
        </div>
        <div style="display:flex; gap:10px;">
          <button id="backToQuiz" class="btn btn-primary">üìù Take Quiz</button>
        </div>
      </header>

      <!-- Top Row: Metrics (Pastel Cards) -->
      <section class="metrics-grid">
        <!-- Green Card: Study Time -->
        <div class="metric-card green">
          <div style="display:flex; justify-content:space-between;">
            <div class="card-icon"><i class="fas fa-microphone-alt"></i></div>
            <div class="card-title">Study Time</div>
          </div>
          <div>
            <div class="card-value" id="studyTime">00:00</div>
            <div class="card-trend trend-up" id="timeTrend">‚Üó +2.5 hrs</div>
          </div>
          <!-- Hidden logic element usually, but mapped here visually -->
        </div>

        <!-- Orange Card: BECE Readiness -->
        <div class="metric-card orange">
          <div style="display:flex; justify-content:space-between;">
            <div class="card-icon"><i class="fas fa-chart-line"></i></div>
            <div class="card-title">BECE Readiness</div>
          </div>
          <div style="display:flex; align-items:center; gap: 15px;">
            <div>
              <div class="card-value" id="mainReadinessValue">0%</div>
              <div class="card-trend" id="readinessTrend">Calculating...</div>
            </div>
            <!-- Visual Ring -->
            <div style="position:relative; width: 60px; height: 60px;">
              <svg class="progress-ring" width="60" height="60">
                <circle stroke="rgba(0,0,0,0.1)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" />
                <circle id="progressCircle" stroke="#FF9500" stroke-width="4" fill="transparent" r="26" cx="30" cy="30"
                  stroke-dasharray="163" stroke-dashoffset="163"
                  style="transition: stroke-dashoffset 1s; transform: rotate(-90deg); transform-origin: 50% 50%;" />
              </svg>
              <div
                style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:12px; font-weight:bold;"
                id="miniReadinessValue">0</div>
            </div>
          </div>
        </div>

        <!-- Yellow Card: Total Courses/Quizzes -->
        <div class="metric-card yellow">
          <div style="display:flex; justify-content:space-between;">
            <div class="card-icon"><i class="fas fa-clock"></i></div>
            <div class="card-title">Total Quizzes</div>
          </div>
          <div>
            <div class="card-value" id="totalQuestions">04</div>
            <div class="card-trend" id="questionsTrend">4 Credit</div>
          </div>
          <div style="display:none" id="studyStreak"></div> <!-- Hidden preservations -->
          <div style="display:none" id="streakTrend"></div>
        </div>
      </section>

      <!-- Middle Row: Charts & Lists -->
      <section class="middle-grid">
        <!-- Big Graph -->
        <div class="content-card">
          <div class="section-title">
            <span>Activity Hours</span>
            <button class="btn btn-ghost" style="font-size:12px;">Weekly ‚ñº</button>
          </div>
          <div class="chart-wrapper">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>

        <!-- Focus Areas Checklist -->
        <div class="content-card">
          <div class="section-title">
            <span>Assignments</span> <!-- "Focus Areas" mapped to "Assignment" UI slot -->
          </div>
          <div id="weakAreasList" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Populated by JS -->
          </div>
        </div>
      </section>

      <!-- Bottom Row: Recent Activity -->
      <section class="content-card">
        <div class="section-title">
          <span>Time Schedule</span> <!-- "Recent Activity" mapped to "Time Schedule" UI slot -->
          <button class="btn btn-ghost" style="font-size:12px;">See All</button>
        </div>
        <div id="activityTimeline" class="timeline-container">
          <!-- Populated by JS -->
        </div>
      </section>
    </main>

    <!-- 3. Right Panel -->
    <aside class="right-panel">
      <div class="profile-header">
        <div class="avatar-large">üë®‚Äçüéì</div>
        <h3>Kwame O.</h3>
        <p style="color:var(--text-muted); font-size:14px;">@kwame_student</p>

        <div class="profile-stats-row">
          <div class="mini-stat"><i class="far fa-clock"></i><b>78h</b></div>
          <div class="mini-stat"><i class="fas fa-clipboard-list"></i><b>4</b></div>
          <div class="mini-stat"><i class="fas fa-check-circle"></i><b>19</b></div>
        </div>
      </div>

      <div class="section-title">Calender</div>
      <!-- Moving Subject Chart here as it fits the "Calendar" circle vibe visually -->
      <div class="calendar-widget">
        <div style="width: 100%; height: 200px;">
          <canvas id="subjectChart"></canvas>
        </div>
      </div>

      <div class="notice-board">
        <div class="section-title">Notice Board</div>
        <div style="font-size:12px; color:var(--text-muted); display:flex; flex-direction:column; gap:15px;">
          <div style="display:flex; gap:10px;">
            <div
              style="background:#000; color:#fff; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px;">
              i</div>
            <div>
              <b>Exam Schedule Release</b>
              <p>Check the new BECE timetable.</p>
            </div>
          </div>
          <div style="display:flex; gap:10px;">
            <div
              style="background:#000; color:#fff; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px;">
              i</div>
            <div>
              <b>New Science Module</b>
              <p>Photosynthesis content added.</p>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { AnalyticsEngine } from "./js/analytics.js";
    import { app } from "./js/auth.js";

    const auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      await initializeDashboard(user);
    });

    async function initializeDashboard(user) {
      const analytics = new AnalyticsEngine(user.uid);

      try {
        const data = await analytics.loadData(30);
        if (data.insights.length === 0) {
          showNoDataState();
          return;
        }

        const progress = analytics.calculateOverallProgress();
        const recommendations = analytics.generateRecommendations();

        // Update readiness score
        updateReadinessScore(progress.readinessScore);

        // Update quick stats
        updateQuickStats(progress);

        // Render charts
        renderPerformanceChart(analytics);
        renderSubjectChart(analytics);

        // Render weak areas
        renderWeakAreas(recommendations);

        // Render activity timeline (prefer granular history)
        const timelineData = (data.history && data.history.length > 0)
          ? data.history.slice(0, 5).reverse()
          : data.insights.slice(-5);

        renderActivityTimeline(timelineData);

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showErrorState();
      }

      // Event listeners
      document.getElementById('backToQuiz').addEventListener('click', () => {
        window.location.href = 'quiz.html';
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = 'index.html');
      });
    }

    function updateReadinessScore(score) {
      const mainValueEl = document.getElementById('mainReadinessValue');
      const miniValueEl = document.getElementById('miniReadinessValue');
      const trendEl = document.getElementById('readinessTrend');
      const circle = document.getElementById('progressCircle');

      // Animate Main Counter
      animateCounter(mainValueEl, 0, score, 2000);

      // Update Mini Value
      miniValueEl.textContent = score; // No % needed inside small circle if tight

      // Update Circle Ring
      const circumference = 2 * Math.PI * 85; // This seems large for r=26? 
      // r=26 -> circumference = 2 * PI * 26 ‚âà 163. Updated to match SVG.
      const realCircum = 163;
      const offset = realCircum - (score / 100) * realCircum;
      circle.style.strokeDasharray = realCircum;
      circle.style.strokeDashoffset = offset;

      // Update Trend / Message
      if (score >= 80) {
        trendEl.textContent = "üéâ Exam Ready!";
        trendEl.className = "card-trend trend-up";
        circle.style.stroke = '#10B981';
      } else if (score >= 60) {
        trendEl.textContent = "üëç On Track";
        trendEl.className = "card-trend trend-up";
        circle.style.stroke = '#06B6D4';
      } else {
        trendEl.textContent = "üí™ Needs Work";
        trendEl.className = "card-trend trend-down";
        circle.style.stroke = '#F59E0B';
      }
    }

    function updateQuickStats(progress) {
      document.getElementById('totalQuestions').textContent = progress.totalQuestions;
      // Removed avgAccuracy from Quick Stats as it's now replaced by Readiness
      // document.getElementById('avgAccuracy').textContent = progress.accuracy + '%';

      document.getElementById('studyStreak').textContent = (progress.consistencyScore > 70 ? '7+' : '3') + ' days';
      document.getElementById('studyTime').textContent = (progress.totalStudyTime / 60).toFixed(1) + ' hrs';

      // Add trend indicators
      document.getElementById('questionsTrend').textContent = '‚Üó +12 this week';
      // document.getElementById('accuracyTrend').textContent = progress.accuracy > 70 ? '‚Üó +5%' : '‚Üí Stable';
      document.getElementById('streakTrend').textContent = 'üî• Keep it up!';
      document.getElementById('timeTrend').textContent = '‚Üó +2.3 hrs';
    }

    function renderPerformanceChart(analytics) {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      const insights = analytics.insights.slice(-7);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: insights.map(d => new Date(d.date).toLocaleDateString('en-US', { weekday: 'short' })),
          datasets: [{
            label: 'Accuracy',
            data: insights.map(d => d.totalQuestions > 0 ? (d.correctAnswers / d.totalQuestions) * 100 : 0),
            borderColor: '#7C3AED',
            backgroundColor: 'rgba(124, 58, 237, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 6,
            pointBackgroundColor: '#7C3AED',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1E293B',
              padding: 12,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#7C3AED',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: { color: '#E5E7EB', drawBorder: false },
              ticks: { color: '#64748B', callback: value => value + '%' }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#64748B' }
            }
          }
        }
      });
    }

    function renderSubjectChart(analytics) {
      const ctx = document.getElementById('subjectChart').getContext('2d');
      const subjects = {};

      Object.values(analytics.topicPerformance).forEach(t => {
        if (!subjects[t.subject]) subjects[t.subject] = { total: 0, correct: 0 };
        subjects[t.subject].total += t.total;
        subjects[t.subject].correct += t.correct;
      });

      const labels = Object.keys(subjects);
      const data = labels.map(s => (subjects[s].correct / subjects[s].total) * 100);

      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Mastery',
            data: data,
            borderColor: '#06B6D4',
            backgroundColor: 'rgba(6, 182, 212, 0.2)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#06B6D4',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              grid: { color: '#E5E7EB' },
              angleLines: { color: '#E5E7EB' },
              pointLabels: { color: '#1E293B', font: { size: 12, weight: '600' } },
              ticks: { display: false }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function renderWeakAreas(recommendations) {
      const container = document.getElementById('weakAreasList');
      const weakAreas = recommendations.filter(r => r.priority === 'high' || r.priority === 'medium').slice(0, 5);

      if (weakAreas.length === 0) {
        container.innerHTML = '<div class="no-data">üéâ Great job! No weak areas detected.</div>';
        return;
      }

      container.innerHTML = weakAreas.map(area => {
        let foundationsHtml = '';
        if (area.foundations && area.foundations.length > 0) {
          foundationsHtml = `
                  <div style="margin-top:8px;">
                      <span style="font-size:11px; color:#6b7280; font-weight:600;">PREREQUISITES:</span>
                      <div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:4px;">
                          ${area.foundations.map(f => `<span style="background:#f3f4f6; color:#4b5563; padding:2px 8px; border-radius:4px; font-size:11px;">${f}</span>`).join('')}
                      </div>
                  </div>`;
        }

        return `
            <div class="weak-area-item ${area.priority}">
              <div class="weak-area-header">
                <span class="priority-badge ${area.priority}">${area.priority.toUpperCase()}</span>
                <h4>${area.title}</h4>
              </div>
              <p>${area.message}</p>
              <div class="action-tip">üí° ${area.action}</div>
              ${foundationsHtml}
            </div>
          `;
      }).join('');
    }

    function renderActivityTimeline(recentInsights) {
      const container = document.getElementById('activityTimeline');

      if (recentInsights.length === 0) {
        container.innerHTML = '<div class="no-data">No recent activity</div>';
        return;
      }

      container.innerHTML = recentInsights.reverse().map(insight => {
        const total = insight.totalQuestions || 0;
        const correct = insight.correctAnswers !== undefined ? insight.correctAnswers : (insight.correctCount || 0);
        const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
        const icon = accuracy >= 70 ? '‚úÖ' : accuracy >= 50 ? '‚ö†Ô∏è' : '‚ùå';

        return `
          <div class="timeline-item">
            <div class="timeline-icon">${icon}</div>
            <div class="timeline-content">
              <div class="timeline-header">
                <h4>${insight.mode ? (insight.mode === 'practice' ? 'Practice Quiz' : 'Exam Simulation') : 'Quiz Session'}</h4>
                <span class="timeline-date">${new Date(insight.date).toLocaleDateString()}</span>
              </div>
              <p>${correct}/${total} correct (${accuracy}%)</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function animateCounter(element, start, end, duration) {
      const range = end - start;
      const increment = range / (duration / 16);
      let current = start;

      const timer = setInterval(() => {
        current += increment;
        if (current >= end) {
          element.textContent = Math.round(end) + '%';
          clearInterval(timer);
        } else {
          element.textContent = Math.round(current) + '%';
        }
      }, 16);
    }

    function showNoDataState() {
      // FIX: .container does not exist, use .main-content to preserve sidebar or .dashboard-container to wipe all
      const container = document.querySelector('.main-content') || document.querySelector('.dashboard-container');

      if (container) {
        container.innerHTML = `
          <div class="no-data-state" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center; padding: 2rem;">
            <div class="no-data-icon" style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
            <h2>No Data Available Yet</h2>
            <p style="color: grey; margin-bottom: 2rem;">Taking quizzes requires an internet connection to sync your specialized analytics.</p>
            <button class="btn btn-primary" onclick="window.location.href='quiz.html'">Take a Quiz Now</button>
          </div>
        `;
      }
    }

    function showErrorState() {
      const container = document.querySelector('.main-content') || document.querySelector('.dashboard-container');

      if (container) {
        container.innerHTML = `
          <div class="no-data-state" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center; padding: 2rem;">
            <div class="no-data-icon" style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
            <h2>Connection Issue</h2>
            <p style="color: grey; margin-bottom: 2rem;">We couldn't load your innovative analytics. Please check your internet.</p>
            <button class="btn btn-primary" onclick="location.reload()">Retry Connection</button>
          </div>
        `;
      }
    }
  </script>
</body>

</html>