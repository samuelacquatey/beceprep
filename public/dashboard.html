<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BECE Prep - Analytics Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="css/dashboard-v2.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">BE</div>
        <div>
          <h1>BECE Prep Analytics</h1>
          <p>Track your progress and improve your performance</p>
        </div>
      </div>
      <div class="header-actions">
        <button id="backToQuiz" class="btn btn-secondary">üìù Take Quiz</button>
        <button id="logoutBtn" class="btn btn-ghost">Logout</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Hero Section - Readiness Score -->
    <section class="hero-section">
      <div class="readiness-card">
        <h2>Your BECE Readiness</h2>
        <div class="readiness-circle">
          <svg class="progress-ring" width="200" height="200">
            <circle class="progress-ring-bg" cx="100" cy="100" r="85" />
            <circle class="progress-ring-fill" cx="100" cy="100" r="85" id="progressCircle" />
          </svg>
          <div class="readiness-score">
            <span class="score-value" id="readinessValue">--</span>
            <span class="score-label">Ready</span>
          </div>
        </div>
        <p class="readiness-message" id="readinessMessage">Loading your progress...</p>
      </div>
    </section>

    <!-- Quick Stats -->
    <section class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <h3 id="totalQuestions">--</h3>
          <p>Questions Solved</p>
          <span class="stat-trend" id="questionsTrend"></span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üéØ</div>
        <div class="stat-content">
          <h3 id="avgAccuracy">--%</h3>
          <p>Average Accuracy</p>
          <span class="stat-trend" id="accuracyTrend"></span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üî•</div>
        <div class="stat-content">
          <h3 id="studyStreak">-- days</h3>
          <p>Study Streak</p>
          <span class="stat-trend" id="streakTrend"></span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚è±Ô∏è</div>
        <div class="stat-content">
          <h3 id="studyTime">-- hrs</h3>
          <p>Total Study Time</p>
          <span class="stat-trend" id="timeTrend"></span>
        </div>
      </div>
    </section>

    <!-- Performance Chart -->
    <section class="chart-section">
      <div class="section-header">
        <h2>üìà Performance Trend</h2>
        <p>Your accuracy over the last 7 days</p>
      </div>
      <div class="chart-container">
        <canvas id="performanceChart"></canvas>
      </div>
    </section>

    <!-- Subject Performance & Weak Areas -->
    <section class="insights-grid">
      <!-- Subject Radar -->
      <div class="insight-card">
        <div class="section-header">
          <h2>üìö Subject Performance</h2>
          <p>Your mastery across all subjects</p>
        </div>
        <div class="chart-container">
          <canvas id="subjectChart"></canvas>
        </div>
      </div>

      <!-- Weak Areas -->
      <div class="insight-card">
        <div class="section-header">
          <h2>‚ö†Ô∏è Focus Areas</h2>
          <p>Topics that need your attention</p>
        </div>
        <div id="weakAreasList" class="weak-areas-list">
          <!-- Populated by JS -->
        </div>
      </div>
    </section>

    <!-- Recent Activity Timeline -->
    <section class="activity-section">
      <div class="section-header">
        <h2>üìù Recent Activity</h2>
        <p>Your latest quiz attempts</p>
      </div>
      <div id="activityTimeline" class="activity-timeline">
        <!-- Populated by JS -->
      </div>
    </section>
  </main>

  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { AnalyticsEngine } from "./js/analytics.js";
    import { app } from "./js/auth.js";

    const auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      await initializeDashboard(user);
    });

    async function initializeDashboard(user) {
      const analytics = new AnalyticsEngine(user.uid);

      try {
        const data = await analytics.loadData(30);
        if (data.insights.length === 0) {
          showNoDataState();
          return;
        }

        const progress = analytics.calculateOverallProgress();
        const recommendations = analytics.generateRecommendations();

        // Update readiness score
        updateReadinessScore(progress.readinessScore);

        // Update quick stats
        updateQuickStats(progress);

        // Render charts
        renderPerformanceChart(analytics);
        renderSubjectChart(analytics);

        // Render weak areas
        renderWeakAreas(recommendations);

        // Render activity timeline (prefer granular history)
        const timelineData = (data.history && data.history.length > 0)
          ? data.history.slice(0, 5).reverse()
          : data.insights.slice(-5);

        renderActivityTimeline(timelineData);

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showErrorState();
      }

      // Event listeners
      document.getElementById('backToQuiz').addEventListener('click', () => {
        window.location.href = 'quiz.html';
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = 'index.html');
      });
    }

    function updateReadinessScore(score) {
      const scoreEl = document.getElementById('readinessValue');
      const messageEl = document.getElementById('readinessMessage');
      const circle = document.getElementById('progressCircle');

      // Animate counter
      animateCounter(scoreEl, 0, score, 2000);

      // Update circle
      const circumference = 2 * Math.PI * 85;
      const offset = circumference - (score / 100) * circumference;
      circle.style.strokeDashoffset = offset;

      // Update message
      if (score >= 80) {
        messageEl.textContent = "üéâ Excellent! You're well prepared for the BECE!";
        circle.style.stroke = '#10B981';
      } else if (score >= 60) {
        messageEl.textContent = "üëç Good progress! Keep practicing to improve.";
        circle.style.stroke = '#06B6D4';
      } else {
        messageEl.textContent = "üí™ Keep going! More practice will boost your readiness.";
        circle.style.stroke = '#F59E0B';
      }
    }

    function updateQuickStats(progress) {
      document.getElementById('totalQuestions').textContent = progress.totalQuestions;
      document.getElementById('avgAccuracy').textContent = progress.accuracy + '%';
      document.getElementById('studyStreak').textContent = (progress.consistencyScore > 70 ? '7+' : '3') + ' days';
      document.getElementById('studyTime').textContent = (progress.totalStudyTime / 60).toFixed(1) + ' hrs';

      // Add trend indicators
      document.getElementById('questionsTrend').textContent = '‚Üó +12 this week';
      document.getElementById('accuracyTrend').textContent = progress.accuracy > 70 ? '‚Üó +5%' : '‚Üí Stable';
      document.getElementById('streakTrend').textContent = 'üî• Keep it up!';
      document.getElementById('timeTrend').textContent = '‚Üó +2.3 hrs';
    }

    function renderPerformanceChart(analytics) {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      const insights = analytics.insights.slice(-7);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: insights.map(d => new Date(d.date).toLocaleDateString('en-US', { weekday: 'short' })),
          datasets: [{
            label: 'Accuracy',
            data: insights.map(d => d.totalQuestions > 0 ? (d.correctAnswers / d.totalQuestions) * 100 : 0),
            borderColor: '#7C3AED',
            backgroundColor: 'rgba(124, 58, 237, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 6,
            pointBackgroundColor: '#7C3AED',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1E293B',
              padding: 12,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#7C3AED',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: { color: '#E5E7EB', drawBorder: false },
              ticks: { color: '#64748B', callback: value => value + '%' }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#64748B' }
            }
          }
        }
      });
    }

    function renderSubjectChart(analytics) {
      const ctx = document.getElementById('subjectChart').getContext('2d');
      const subjects = {};

      Object.values(analytics.topicPerformance).forEach(t => {
        if (!subjects[t.subject]) subjects[t.subject] = { total: 0, correct: 0 };
        subjects[t.subject].total += t.total;
        subjects[t.subject].correct += t.correct;
      });

      const labels = Object.keys(subjects);
      const data = labels.map(s => (subjects[s].correct / subjects[s].total) * 100);

      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Mastery',
            data: data,
            borderColor: '#06B6D4',
            backgroundColor: 'rgba(6, 182, 212, 0.2)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#06B6D4',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              grid: { color: '#E5E7EB' },
              angleLines: { color: '#E5E7EB' },
              pointLabels: { color: '#1E293B', font: { size: 12, weight: '600' } },
              ticks: { display: false }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function renderWeakAreas(recommendations) {
      const container = document.getElementById('weakAreasList');
      const weakAreas = recommendations.filter(r => r.priority === 'high' || r.priority === 'medium').slice(0, 5);

      if (weakAreas.length === 0) {
        container.innerHTML = '<div class="no-data">üéâ Great job! No weak areas detected.</div>';
        return;
      }

      container.innerHTML = weakAreas.map(area => `
        <div class="weak-area-item ${area.priority}">
          <div class="weak-area-header">
            <span class="priority-badge ${area.priority}">${area.priority.toUpperCase()}</span>
            <h4>${area.title}</h4>
          </div>
          <p>${area.message}</p>
          <div class="action-tip">üí° ${area.action}</div>
        </div>
      `).join('');
    }

    function renderActivityTimeline(recentInsights) {
      const container = document.getElementById('activityTimeline');

      if (recentInsights.length === 0) {
        container.innerHTML = '<div class="no-data">No recent activity</div>';
        return;
      }

      container.innerHTML = recentInsights.reverse().map(insight => {
        const total = insight.totalQuestions || 0;
        const correct = insight.correctAnswers !== undefined ? insight.correctAnswers : (insight.correctCount || 0);
        const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
        const icon = accuracy >= 70 ? '‚úÖ' : accuracy >= 50 ? '‚ö†Ô∏è' : '‚ùå';

        return `
          <div class="timeline-item">
            <div class="timeline-icon">${icon}</div>
            <div class="timeline-content">
              <div class="timeline-header">
                <h4>${insight.mode ? (insight.mode === 'practice' ? 'Practice Quiz' : 'Exam Simulation') : 'Quiz Session'}</h4>
                <span class="timeline-date">${new Date(insight.date).toLocaleDateString()}</span>
              </div>
              <p>${correct}/${total} correct (${accuracy}%)</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function animateCounter(element, start, end, duration) {
      const range = end - start;
      const increment = range / (duration / 16);
      let current = start;

      const timer = setInterval(() => {
        current += increment;
        if (current >= end) {
          element.textContent = Math.round(end) + '%';
          clearInterval(timer);
        } else {
          element.textContent = Math.round(current) + '%';
        }
      }, 16);
    }

    function showNoDataState() {
      document.querySelector('.container').innerHTML = `
        <div class="no-data-state">
          <div class="no-data-icon">üìä</div>
          <h2>No Data Yet</h2>
          <p>Start taking quizzes to see your analytics dashboard</p>
          <button class="btn btn-primary" onclick="window.location.href='quiz.html'">Take Your First Quiz</button>
        </div>
      `;
    }

    function showErrorState() {
      document.querySelector('.container').innerHTML = `
        <div class="no-data-state">
          <div class="no-data-icon">‚ö†Ô∏è</div>
          <h2>Unable to Load Data</h2>
          <p>Please try refreshing the page</p>
          <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
        </div>
      `;
    }
  </script>
</body>

</html>